using CuttingEdge.Conditions;

namespace SFA.Apprenticeships.Infrastructure.Postcode
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
<<<<<<< HEAD
    using SFA.Apprenticeships.Application.Common.Mappers;
    using SFA.Apprenticeships.Application.Interfaces.Postcode;
    using SFA.Apprenticeships.Infrastructure.Common.Rest;
    using SFA.Apprenticeships.Infrastructure.Postcode.Entities;
    using PostcodeInfo = SFA.Apprenticeships.Domain.Entities.Postcode.PostcodeInfo;

    public class PostcodeService : RestService, IPostcodeService
=======
    using Common.Rest;
    using Entities;
    using Application.Interfaces.Location;
    using Domain.Entities.Location;

    /// <summary>
    /// <add key="PostcodeServiceEndpoint" value="http://api.postcodes.io" />
    /// </summary>
    public class PostcodeService : RestService, IPostcodeLookupProvider
>>>>>>> refactored some app service projects
    {
        public PostcodeService(string baseUrl) : base(baseUrl) {}

        public Location GetLocation(string postcode)
        {
            var result = GetPartialMatches(postcode).FirstOrDefault();

            return result == null
                ? null
                : new Location
                {
                    Name = postcode,
                    GeoPoint = new GeoPoint {Latitude = result.Latitude, Longitude = result.Longitude}
                };
        }

        public IEnumerable<Address> FindAddresses(string postcode)
        {
            //todo: needs an address lookup
            throw new NotImplementedException();
        }

        private IEnumerable<PostcodeInfo> GetPartialMatches(string postcode)
        {
            Condition.Requires(postcode).IsNotNullOrEmpty();

            var request = Create("postcodes?q={postcode}", new[] {new KeyValuePair<string, string>("postcode", postcode)});
            var postcodes = Execute<PostcodeInfoResult>(request);

            if (postcodes.Data != null && postcodes.Data.Result != null)
                return postcodes.Data.Result.AsEnumerable();

            return null;
        }
    }
}
